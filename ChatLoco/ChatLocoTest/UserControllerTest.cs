
                                                                    /*.;lxoollccclllodOd.                                            
                                                                    .;clollccccccccccclldlc:.                                         
                                                                    .,lolcccccccccccccccccccldo;.                                       
                                                                    .:lllccccccccccccccccccccccclod'                                      
                                                                    .ldlcccccccccccccccccccccccccccll;.                                    
                                                                    .ldlccccccccccccccccccccccccccccclxo.                                   
                                                                    ..lxlccccccccccccccccccccccccccccccclx:                                   
                                                                    .;::lollcccccccccccccccccccccccccccccccccoc.                                  
                                                                    .:oollccccccccccccccccccccccccccccccccccccclx:                                  
                                                                    .oxlccccccccccccccccccccccccccccccccccccccccld;                                  
                                                                    ;xlccccccccccccccccccccccccccccccccccccccccclx;                                  
                                                                    ,occcccccccccccccccccccccccccccccccccccccccclk:                                  
                                                                    'lcccccccccccccccccccccccccccccccccccccccccclxo.                                 
                                                                    ,occccccccccccccccccccccccccccccccccccccccccclxx,                                
                                                                    'olcccccccccccccccccccccccccccccccccccccccccccldx,                               
                                                                    :xlcccccccccccccccccccccccccccccccccccccccccccldl.                              
                                                                    .oxlccccccccccccccccccccccccccccccccccccccccccclOc                              
                                                                    .:oollccccccccccccccccccccccccccccccccccccccccld;                              
                                                                    ,xkxoccccccccccccccccccccccccccccccccccccccccd;                              
                                                                    .':xxolcccccccccccccccccccccccccccccccccccclx:                              
.,,,,,.                                                                 .';dxdolccccccccccccccccccccccccccccccccoxl'''.                          
.,lxxxxxxxxxl,. lNK0KNl                                                   .''cdlccccccccccccccccccccccccccccccclooodxoc;'.                      
.lx0X0OkxxxxxkkOXK,lKocdKl                                 .,,lkk,              ,xdlcccccccccccccccccccccccccccccccccccclloxd:.                    
.l0Kkdolodxkkkkxdd0WllKocoKl                                 lWKO0Nl               .lxlcccccccccccccccccccccccccccccccccccccccldd:.                  
,KXkoldkKOdxl,lxxddxl.lKocdKl .,.              .,. .,,.       lKdcdKl                .clldllccccccccccccccccccccccccccccccccccccllddl:.               
KKdclkXx,.            lKocoKKxOXklodxl,.   .,lxOXklkXN0xl. ,xdO0oco0Odddx,              .;cokxdooodxdoccccccccccccccccccccccccccccclldl,'.            
XdclkNx.              lKoco00kdoolodkKWk.  lW0xdddddooxOXK,lXkdolclodddkNl                 .,,'...'':xdlccccccccccccccccccccccccccccccclxl.           
OlcdXK,               lKocloxO0KK0xlco0Wl  lWKOKXOoOKkoldKxl0XKkocok0KKXWl                           .:odlccccccccccccccccccccccccccccccloo'          
xccxNl                lKoclkXKl,,xNOlcdKK, .lkllkl,lKNkllkNl.,xKdcoKx,,,,.  'c,',c'                    .:clollllccccllccccccccccccccccccccoo'         
xccxXl                lKocoKK,   .xKdco0x.  .lxOK0OOkkdlcxXl  lKdcdKl       'x0K0x'                       .';cc::;;:clllccccccccccccccccccco;         
OlcdKK,               lKocoKl     lXdco0l ,xO0xoodxkkkxlcdXl  lKdcoKl       'xNWXx.                                   ,codlllcccccccccccccclcc;.      
XdclxXK,              lKocoKl     lXdco0l.xNkllxKNKxx00ocdXl  lKdcoKl       'xNMXx.                .,'..',.             ,okkooxxxxxxxdlcccccclolc:.   
0KdlldK0l,,.   .,,,,. lKocoKl     lXdco0clW0ocdKKl..l0OlcdXl  lKdcoKK,      'xNMXx.            .';cd00OO00dc;'.      .;cd0KOkO00OOo,,ldllodxxxxddxx'  
,KXkolldO0XOdddOXKKNK,lKocoKl     lXdco0c,KKdcoOX0x0XOoccdXl  lXxclkXOdxx,  'xNWXx.          .;dO0KNNNXNNNNKOOl.   .,dOKXNNNNNNNKx,.:xOOKXNNXNNNX0Oo,.
.lKXOxdolloodooood0WllKdldKl     lXdlo0l ,0KxllodxddxkdldXx. ,0KdlloddONl   'xNWXx.         .ok0NWN00xlx00KWWXOd' .oOXWWX0000000OOolk0NWN00xlx0OXWWXOd
.,lxOXK0OOOO00KX0x,lWXKXWl     lWXKKNl  ,x0X0OO0KOx0XKXWK,  .lOK0OO0XK,     'xNWXx.         :k0WWXOo:. .'lk0WMNOdoo0NMNOo;',,,'..'lk0WWXkd:. .'ck0WWXk
.,,,,,,,,,,,.  .,,,,,.     .,,,,,.    .,,,,,,. .,,,,.     .,,,,,,.          'xNWXx.         ,kXMW0O:     .lkXWWKkkkXWW0O:        'dkNMN0d'     .ckXWWK
                                                                            'xNWXx.         ,kNMNO0c      :OKWWKxdONMNO0c        ,dONMNO,       ;kKWWK
                                                                            'xNMXx.         ,kXMNOO:      ;kKWWKkxONMW0O:        'oONMNOd'     .lkXMWK
                                                                            'xNWXx;'''''''''lkKWWXkd:.  .;o0NMNOdxkKWWNOd;'. .,'.'lkKWWXk:.   .lk0NWXk
                                                                            'xNMN0O000000000kkO0NWN0Oxccd0KNWXOd'.oO0NWNK00xcx00OOooOKNWX0dclldOKWWXOd
                                                                            'xXWWNNNNNNNNNNKxOkdOKXNNNNNNNNK0Ol.  .;oOKXNWNNNNNNKk,.;oOKXNNNXNNNNK0d,.
                                                                            ,dkkkkkkkkkkkkkxxo'.dOkOKKKKKOkko:'     .dkxO0KKKK0Okk;  .dOkOKKKK0Okko.*/

using ChatLoco.Controllers;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using System.Collections.Generic;
using System.Web.Mvc;
using ChatLoco.Models.User_Model;
using ChatLoco.DAL;
using ChatLoco.Services.User_Service;

namespace ChatLocoTest
{
    [TestClass]
    public class UserControllerTest
    {

        /* --This section is run everytime before any of the tests-- */
        /* --ensures the database doesn't have left over data from previous tests so that each time we run the tests the data is consistent--*/
/*###########################################################################################################################################*/

        //Need a reference to the db context
        private ChatLocoContext _db = new ChatLocoContext();
        //TestHelper that will hold all of the created users
        private TestHelper _helper;

        /*constructor - create an instance of TestHelper passing in the users we want to use for testing*/
        public UserControllerTest()
        {

            List < UserTestModel > newUsers = new List<UserTestModel>();
            newUsers.Add(new UserTestModel() { Username = "test_usercontroller_00", Password = "testusercontroller00", Email = "test_usercontroller_00@test.com", Id = -1, DefaultHandle = "test_usercontroller_00" });//getUserInfo, login
            newUsers.Add(new UserTestModel() { Username = "test_usercontroller_01", Password = "testusercontroller01", Email = "test_usercontroller_01@test.com", Id = -1, DefaultHandle = "test_usercontroller_01" });//createUser

            _helper = new TestHelper(newUsers, new List<int>() { 1 });
        }


        /* --This section includes default View functions-- */
/*###########################################################################################################################################*/

        /*Call the Index method: The Index view*/
        [TestMethod]
        public void TestIndexView()
        {
            UserController userControllerTest = new UserController();
            var result = userControllerTest.Index() as ViewResult;
            Assert.AreEqual("", result.ViewName);
        }

        /*Call the Settings method: The Settings view*/
        [TestMethod]
        public void TestSettingsView()
        {
            UserController userControllerTest = new UserController();
            var result = userControllerTest.Settings() as ViewResult;
            Assert.AreEqual("", result.ViewName);
        }

        /*Call the Create method: The Create view*/
        [TestMethod]
        public void TestCreateView()
        {
            UserController userControllerTest = new UserController();
            var result = userControllerTest.Index() as ViewResult;
            Assert.AreEqual("", result.ViewName);
        }

        /*Call the Login method: The Login view with no actual html*/
        [TestMethod]
        public void TestLoginView()
        {
            UserController userControllerTest = new UserController();
            var result = userControllerTest.Index() as ViewResult;
            Assert.AreEqual("", result.ViewName);
        }

        /* --This section includes Partial View functions-- */
/*###########################################################################################################################################*/
        
        /*Call the GetLoginForm method: The partial view _Login.cshtml*/
        [TestMethod]
        public void TestGetLoginForm()
        {
            UserController userControllerTest = new UserController();
            var result = userControllerTest.GetLoginForm() as PartialViewResult;
            Assert.AreEqual("~/Views/User/_Login.cshtml", result.ViewName);
        }

        /*Call the GetSettingsForm method: The partial view _Settings.cshtml*/
        [TestMethod]
        public void TestGetSettingsForm()
        {
            UserController userControllerTest = new UserController();
            var result = userControllerTest.GetSettingsForm() as PartialViewResult;
            Assert.AreEqual("~/Views/Settings/_Settings.cshtml", result.ViewName);
        }


        /*Call the GetManageUsersForm method: The partial view Index.cshtml*/
        [TestMethod]
        public void TestGetManageUsersForm()
        {
            UserController userControllerTest = new UserController();
            var result = userControllerTest.GetManageUsersForm() as PartialViewResult;
            Assert.AreEqual("~/Views/ManageUsers/Index.cshtml", result.ViewName);
        }


        /* --This section is the fun stuff. Begin testing database functions-- */
/*###########################################################################################################################################*/

        /*Call the UserInfo method: Retreieve information about the user from the database*/
        [TestMethod]
        public void TestUserInfo()
        {
            var USER = _helper.testUsers[0];

            UserController userControllerTest = new UserController();
            //Pass in test data model
            UserInfoRequestModel model = new UserInfoRequestModel()
            {
                Username = USER.Username,
                Id = USER.Id
            };
            //retrieve the partial view
            var result = userControllerTest.GetUserInfo(model) as PartialViewResult;

            //Ensure the right cshtml page was returned
            Assert.AreEqual("~/Views/User/_UserInfo.cshtml", result.ViewName);
            //Ensure the returned Model is of correct type
            Assert.IsInstanceOfType(result.ViewData.Model, typeof(UserInfoResponseModel));
            //Ensure the partial view's model has correct data filled in
            Assert.AreEqual(USER.Username, ((UserInfoResponseModel)result.ViewData.Model).Username);
            Assert.AreEqual(USER.DefaultHandle, ((UserInfoResponseModel)result.ViewData.Model).DefaultHandle);
            Assert.AreEqual(USER.Email, ((UserInfoResponseModel)result.ViewData.Model).Email);
        }


        /*Call the CreateUser method: A User will be created in the database and return a JsonResult with 0 errors */
        [TestMethod]
        public void TestCreateUser()
        {
            var USER = _helper.testUsers[1];

            UserController userControllerTest = new UserController();
            //Create test data model
            CreateUserRequestModel model = new CreateUserRequestModel()
            {
                Username = USER.Username,
                Password = USER.Password,
                Email = USER.Email
            };

            //Test create user success
            var result = userControllerTest.CreateUser(model) as JsonResult;
            Assert.AreEqual(0, ((CreateUserResponseModel)result.Data).Errors.Count);

            //Test already existing username
            model.Email = "neverBeforeBeenUsedEmail@test.com";
            result = userControllerTest.CreateUser(model) as JsonResult;
            Assert.AreNotEqual(0, ((CreateUserResponseModel)result.Data).Errors.Count);
            Assert.AreEqual("Username already exists.", ((CreateUserResponseModel)result.Data).Errors[0].ErrorMessage);

            //Test already existing email
            model.Email = USER.Email;
            model.Username = ("neverBeforeBeenUsedUsername" + USER.Username);
            result = userControllerTest.CreateUser(model) as JsonResult;
            Assert.AreNotEqual(0, ((CreateUserResponseModel)result.Data).Errors.Count);
            Assert.AreEqual("Email already in use.", ((CreateUserResponseModel)result.Data).Errors[0].ErrorMessage);
        }


        /*Call the Login method: A User will go through login validation passing and failing when appropriate */
        [TestMethod]
        public void TestLogin()
        {
            var USER = _helper.testUsers[0];

            UserController userControllerTest = new UserController();
            //Create test data model
            LoginRequestModel model = new LoginRequestModel()
            {
                Username = USER.Username,
                Password = USER.Password
            };
            //Test login success
            var result = userControllerTest.Login(model) as JsonResult;
            Assert.AreEqual(0, ((LoginResponseModel)result.Data).LoginErrors.Count);
            Assert.AreEqual(USER.Username, ((LoginResponseModel)result.Data).User.Username);
            Assert.AreEqual(USER.Id, ((LoginResponseModel)result.Data).User.Id);
            Assert.AreEqual(USER.DefaultHandle, ((LoginResponseModel)result.Data).User.Settings.DefaultHandle);
            Assert.AreEqual(USER.Email, ((LoginResponseModel)result.Data).User.Settings.Email);

            //Test incorrect password data but existing user fail
            model.Password = "notTheRealPassword";
            result = userControllerTest.Login(model) as JsonResult;
            Assert.AreNotEqual(0, ((LoginResponseModel)result.Data).LoginErrors.Count);
            Assert.AreEqual("Incorrect password.", ((LoginResponseModel)result.Data).LoginErrors[0].ErrorMessage);

            //Test non existing user fail
            model.Password = USER.Password;
            model.Username = "notARealUserSorry";
            result = userControllerTest.Login(model) as JsonResult;
            Assert.AreNotEqual(0, ((LoginResponseModel)result.Data).LoginErrors.Count);
            Assert.AreEqual("Username not found.", ((LoginResponseModel)result.Data).LoginErrors[0].ErrorMessage);

            //Test existing blocked user
            model.Password = USER.Password;
            model.Username = USER.Username;
            UserService.blockUser(model.Username);
            result = userControllerTest.Login(model) as JsonResult;
            Assert.AreNotEqual(0, ((LoginResponseModel)result.Data).LoginErrors.Count);
            Assert.AreEqual("This account has been blocked.<br />Please reach out to us via our contact page if you want to be unblocked.", ((LoginResponseModel)result.Data).LoginErrors[0].ErrorMessage);
        }


        /*Call the UpdateSettings method: A Users settings will be updated to new values */
        [TestMethod]
        public void TestUpdateSettings()
        {
            var USER = _helper.testUsers[0];

            UserController userControllerTest = new UserController();
            //Create test data model
            UpdateSettingsRequestModel model = new UpdateSettingsRequestModel()
            {
                Settings = new UserSettingsModel() { DefaultHandle = USER.DefaultHandle, Email = USER.Email },
                Username = USER.Username
            };

            //Pre-sanity check
            Assert.AreEqual(USER.DefaultHandle, model.Settings.DefaultHandle);
            Assert.AreEqual(USER.Email, model.Settings.Email);

            //Test update settings success
            model.Settings.DefaultHandle = ("UPDATED" + USER.DefaultHandle);
            model.Settings.Email = ("UPDATED" + USER.Email);
            var result = userControllerTest.UpdateSettings(model) as JsonResult;
            Assert.AreNotEqual(USER.DefaultHandle, ((UpdateSettingsResponseModel)result.Data).User.Settings.DefaultHandle);
            Assert.AreNotEqual(USER.Email, ((UpdateSettingsResponseModel)result.Data).User.Settings.Email);
            Assert.AreEqual(("UPDATED" + USER.DefaultHandle), ((UpdateSettingsResponseModel)result.Data).User.Settings.DefaultHandle);
            Assert.AreEqual(("UPDATED" + USER.Email), ((UpdateSettingsResponseModel)result.Data).User.Settings.Email);

            //Test non existing user fail
            model.Username = "notARealUserSorry";
            result = userControllerTest.UpdateSettings(model) as JsonResult;
            Assert.AreNotEqual(0, ((UpdateSettingsResponseModel)result.Data).SettingsErrors.Count);
            Assert.AreEqual("Username not found.", ((UpdateSettingsResponseModel)result.Data).SettingsErrors[0].ErrorMessage);
        }


        /*Call the Logout method: Logs out the user*/
        [TestMethod]
        public void TestLogout()
        {
            var USER = _helper.testUsers[0];

            UserController userControllerTest = new UserController();
            //Create test data model
            LogoutRequestModel model = new LogoutRequestModel()
            {
                UserId = USER.Id,
                ChatroomId = -1,
                ParentChatroomId = -1,
                User = new UserModel() { Id = USER.Id }
            };

            //Test logout success
            var result = userControllerTest.Logout(model) as JsonResult;
            Assert.AreEqual(0, ((LogoutResponseModel)result.Data).Errors.Count);

            //Removing user from chatroom is tested in Chatroom Controller
        }

        /*Call the DirtyLogout method: Logs out the user*/
        [TestMethod]
        public void TestDirtyLogout()
        {
            var USER = _helper.testUsers[0];

            UserController userControllerTest = new UserController();
            //Create test data model
            LogoutRequestModel model = new LogoutRequestModel()
            {
                UserId = USER.Id,
                ChatroomId = -1,
                ParentChatroomId = -1,
                User = new UserModel() { Id = USER.Id }
            };

            //Test logout success
            var result = userControllerTest.DirtyLogout(model) as JsonResult;
            Assert.AreEqual(0, ((LogoutResponseModel)result.Data).Errors.Count);

            //Removing user from chatroom is tested in Chatroom Controller
        }

    }
}
